<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPN System | Srinagarind Hospital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f0f4f0; }
    .gradient-header { background: linear-gradient(135deg, #065f46 0%, #10b981 100%); }
    .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05); }
    .section-title { border-left: 5px solid #10b981; padding-left: 12px; font-weight: 800; color: #000000; font-size: 1.1rem; }
    .ward-dropdown { max-height: 250px; overflow-y: auto; z-index: 100; }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .route-radio:checked + label { background-color: #065f46; color: white; border-color: #065f46; transform: scale(1.02); }
    .hidden { display: none; }
  </style>
</head>
<body class="p-4 md:p-8">

  <div id="loginPage" class="min-h-[80vh] flex items-center justify-center">
    <div class="max-w-md w-full bg-white p-10 rounded-3xl shadow-2xl border border-emerald-50 text-center">
      <div class="inline-block p-4 rounded-2xl bg-emerald-600 text-white mb-4 shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
      </div>
      <h1 class="text-2xl font-black text-emerald-900 mb-6 uppercase tracking-tighter">TPN LOGIN SYSTEM</h1>
      <form onsubmit="handleLogin(event)" class="space-y-4">
        <input type="text" id="username" placeholder="Username" required class="w-full p-4 border-2 border-emerald-50 rounded-2xl focus:border-emerald-500 outline-none font-bold text-center uppercase tracking-widest text-emerald-700 bg-emerald-50/30">
        <input type="password" id="password" placeholder="Password" required class="w-full p-4 border-2 border-emerald-50 rounded-2xl focus:border-emerald-500 outline-none font-bold text-center tracking-widest text-emerald-700 bg-emerald-50/30">
        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white p-5 rounded-2xl font-black text-xl shadow-xl transition-all transform active:scale-95">
          ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö üöÄ
        </button>
      </form>
    </div>
  </div>

  <div id="mainApp" class="max-w-4xl mx-auto hidden">
    <nav class="flex justify-between items-center mb-4">
        <div class="flex items-center gap-2">
            <span class="text-xs font-bold text-gray-400 uppercase tracking-tighter">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</span>
            <span id="displayUserName" class="text-sm font-black text-emerald-700 px-3 py-1 bg-white border border-emerald-100 rounded-xl shadow-sm"></span>
            <button onclick="logout()" class="text-[10px] font-black text-red-400 hover:text-red-600 uppercase ml-2 underline">Logout</button>
        </div>
        <div class="flex gap-2">
            <button class="px-4 py-2 bg-white rounded-xl text-emerald-800 font-black text-xs shadow-sm border border-emerald-50 hover:bg-emerald-50">üìä Dashboard</button>
            <button class="px-4 py-2 bg-white rounded-xl text-emerald-800 font-black text-xs shadow-sm border border-emerald-50 hover:bg-emerald-50">üì¶ Stock</button>
        </div>
    </nav>

    <div class="space-y-6">
        <header class="gradient-header p-8 rounded-3xl shadow-xl">
          <div class="flex justify-between items-center text-white">
            <div>
              <h1 class="text-2xl font-bold uppercase tracking-tight text-white">TPN COMMERCIAL ORDER</h1>
              <p class="text-lg font-medium text-white">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ</p>
              <p class="text-sm uppercase text-white">Srinagarind Hospital</p>
            </div>
            <button onclick="location.reload()" class="text-xs bg-white/20 px-3 py-1 rounded-lg hover:bg-white/30 transition-all text-white border border-white/20">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
          </div>
        </header>

        <section class="bg-white p-6 rounded-2xl card-shadow space-y-4">
          <h2 class="section-title">üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-bold text-gray-600 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà Order</label>
              <input type="date" id="orderDate" class="w-full p-2.5 border rounded-xl bg-gray-50 outline-none">
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-600 mb-1">HN</label>
              <input type="text" id="hn" placeholder="‡∏£‡∏∞‡∏ö‡∏∏ HN" class="w-full p-2.5 border rounded-xl outline-none">
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
              <input type="text" id="patientName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ" class="w-full p-2.5 border rounded-xl outline-none">
            </div>
            <div class="relative">
              <label class="block text-sm font-bold text-gray-600 mb-1">Ward</label>
              <input type="text" id="wardInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." class="w-full p-2.5 border rounded-xl outline-none" onfocus="showWards()" oninput="filterWards()" autocomplete="off">
              <div id="wardList" class="hidden absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-xl shadow-2xl ward-dropdown"></div>
            </div>
          </div>
          <div class="pt-4 border-t border-emerald-50 text-center">
            <label class="block text-sm font-bold text-gray-400 mb-2 uppercase tracking-widest text-center">Route</label>
            <div class="grid grid-cols-2 gap-4">
                <input type="radio" name="route" id="route-central" value="Central Line" class="hidden route-radio" checked>
                <label for="route-central" class="flex items-center justify-center p-3 border-2 border-emerald-50 rounded-xl cursor-pointer font-bold text-emerald-800 transition-all">üü£ Central</label>
                <input type="radio" name="route" id="route-peripheral" value="Peripheral Line" class="hidden route-radio">
                <label for="route-peripheral" class="flex items-center justify-center p-3 border-2 border-emerald-50 rounded-xl cursor-pointer font-bold text-emerald-800 transition-all">üîµ Peripheral</label>
            </div>
          </div>
        </section>

        <section class="bg-white p-6 rounded-2xl card-shadow">
          <h2 class="section-title mb-4">‚öñÔ∏è ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</h2>
          <div class="relative max-w-xs mx-auto md:mx-0">
            <input type="number" id="bw" step="0.1" placeholder="0.0" class="w-full p-4 border-2 border-emerald-100 rounded-2xl pr-16 text-3xl font-black text-emerald-700 outline-none" oninput="calculateAll()">
            <span class="absolute right-4 top-5 text-emerald-300 font-black text-xl">kg</span>
          </div>
        </section>

        <section class="bg-white p-6 rounded-2xl card-shadow space-y-4 border-t-8 border-emerald-600">
          <h2 class="section-title" style="color:#065f46 text-center text-emerald-800">üì¶ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h2>
          <select id="productSelect" class="w-full p-4 border-2 border-emerald-100 rounded-xl bg-emerald-50 text-xl font-black text-emerald-900 outline-none text-center" onchange="updateProductDetails()">
            <option value="">-- ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£ --</option>
            <option value="smof_c_1477" data-vol="1477" data-kcal="1600">SMOF kabiven (C-line) 1,477 ml / 1600 kcal</option>
            <option value="smof_c_986" data-vol="986" data-kcal="1100">SMOF kabiven (C-line) 986 ml / 1100 kcal</option>
            <option value="smof_p_1904" data-vol="1904" data-kcal="1300">SMOF kabiven (P-line) 1,904 ml / 1300 kcal</option>
            <option value="oli_n7" data-vol="1500" data-kcal="1800">Oliclinomel N/7 (C-line) 1,500 ml / 1800 kcal</option>
            <option value="oli_n4" data-vol="1500" data-kcal="910">Oliclinomel N/4 (P-line) 1,500 ml / 910 kcal</option>
            <option value="nutri_p" data-vol="1875" data-kcal="1435">Nutriflex lipid peri 1,875 ml / 1435 kcal</option>
            <option value="nutri_vr" data-vol="1250" data-kcal="1475">Nutriflex lipid VR 1,250 ml / 1475 kcal</option>
            <option value="bfluid" data-vol="1000" data-kcal="420">B-Fluid 1,000 ml / 420 kcal</option>
          </select>

          <div class="bg-emerald-50 p-4 rounded-2xl border border-emerald-100 text-center">
            <label class="block text-xs font-black text-emerald-600 uppercase mb-2 tracking-widest">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏∏‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ö‡∏¥‡∏Å (Stock Out)</label>
            <div class="flex items-center justify-center gap-6">
              <button onclick="changeBag(-1)" class="w-12 h-12 bg-white rounded-full shadow-md text-2xl font-black text-emerald-600 border border-emerald-100 active:scale-90">-</button>
              <span id="bagCountDisplay" class="text-4xl font-black text-emerald-900 w-16 text-center">1</span>
              <button onclick="changeBag(1)" class="w-12 h-12 bg-white rounded-full shadow-md text-2xl font-black text-emerald-600 border border-emerald-100 active:scale-90">+</button>
            </div>
            <input type="hidden" id="bagCount" value="1">
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="p-4 bg-emerald-50 rounded-2xl text-center border border-emerald-100">
                <span class="text-xs font-black text-emerald-600 uppercase">Volume:</span>
                <div class="text-2xl font-black text-emerald-900"><span id="prodVol">0</span> ml</div>
            </div>
            <div class="p-4 bg-yellow-50 rounded-2xl text-center border border-yellow-100">
                <span class="text-xs font-black text-yellow-600 uppercase">Energy:</span>
                <div class="text-2xl font-black text-yellow-900"><span id="prodKcal">0</span> kcal</div>
            </div>
          </div>
        </section>

        <section class="bg-white p-8 rounded-2xl card-shadow space-y-6">
          <h2 class="section-title">üß™ ADDITIVES</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-center">
            <div class="space-y-2">
              <label class="block text-xl font-black text-gray-800 uppercase">Addamel-N (ml)</label>
              <input type="number" id="addamel" value="10" class="w-full p-4 border-2 border-gray-100 rounded-2xl text-3xl font-black text-emerald-700 bg-gray-50 outline-none text-center" oninput="calculateAll()">
            </div>
            <div class="space-y-3">
              <label class="block text-xl font-black text-gray-800 flex justify-between uppercase px-2">Vitamins <span id="vit-max-msg" class="text-xs text-red-500 font-black invisible uppercase tracking-tighter self-center">MAX REACHED</span></label>
              <div class="flex gap-2">
                <button onclick="selectVitamin('cernevit')" id="btn-cernevit" class="flex-1 py-4 rounded-xl border-2 font-black text-xs uppercase bg-white text-gray-400">Cernevit</button>
                <button onclick="selectVitamin('soluvit')" id="btn-soluvit" class="flex-1 py-4 rounded-xl border-2 font-black text-xs uppercase bg-white text-gray-400">Soluvit-N</button>
              </div>
              <input type="number" id="vitVol" class="w-full p-4 border-2 border-gray-100 rounded-2xl text-3xl font-black text-emerald-700 bg-gray-50 outline-none text-center" oninput="calculateAll()">
              <p id="vit-hint" class="text-[10px] font-bold text-gray-400 uppercase italic"></p>
            </div>
            <div class="space-y-2">
              <label class="block text-xl font-black text-gray-800 flex justify-between uppercase px-2">B-CO (ml) <span class="text-xs text-red-500 font-black tracking-tighter self-center uppercase">MAX 2 ml</span></label>
              <input type="number" id="bco" value="2" class="w-full p-4 border-2 border-gray-100 rounded-2xl text-3xl font-black text-emerald-700 bg-gray-50 outline-none text-center" oninput="checkBcoLimit()">
            </div>
            <div class="space-y-2">
              <label class="block text-xl font-black text-gray-800 uppercase">Vitalipid Adult (ml)</label>
              <input type="number" id="vitalipid" value="10" class="w-full p-4 border-2 border-gray-100 rounded-2xl text-3xl font-black text-emerald-700 bg-gray-50 outline-none text-center" oninput="calculateAll()">
            </div>
          </div>

          <div class="space-y-4 pt-8 border-t border-emerald-50 text-left">
            <span class="text-xl font-black text-gray-800 italic block uppercase tracking-widest mb-4">Add ‡∏™‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ</span>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="other-additives">
              <div class="flex gap-3"><input type="text" id="o1-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ 1" class="flex-1 p-3 border border-gray-100 rounded-xl font-bold"><input type="number" id="o1-vol" placeholder="ml" class="w-24 p-3 border border-gray-100 rounded-xl text-center font-black text-emerald-700 other-vol" oninput="calculateAll()"></div>
              <div class="flex gap-3"><input type="text" id="o2-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ 2" class="flex-1 p-3 border border-gray-100 rounded-xl font-bold"><input type="number" id="o2-vol" placeholder="ml" class="w-24 p-3 border border-gray-100 rounded-xl text-center font-black text-emerald-700 other-vol" oninput="calculateAll()"></div>
              <div class="flex gap-3"><input type="text" id="o3-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ 3" class="flex-1 p-3 border border-gray-100 rounded-xl font-bold"><input type="number" id="o3-vol" placeholder="ml" class="w-24 p-3 border border-gray-100 rounded-xl text-center font-black text-emerald-700 other-vol" oninput="calculateAll()"></div>
              <div class="flex gap-3"><input type="text" id="o4-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ 4" class="flex-1 p-3 border border-gray-100 rounded-xl font-bold"><input type="number" id="o4-vol" placeholder="ml" class="w-24 p-3 border border-gray-100 rounded-xl text-center font-black text-emerald-700 other-vol" oninput="calculateAll()"></div>
            </div>
          </div>
        </section>

        <section class="bg-emerald-900 text-white p-8 rounded-3xl shadow-2xl border-b-[12px] border-emerald-700">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10 text-center">
                <div class="space-y-1">
                    <span class="text-emerald-400 font-bold uppercase text-xs tracking-widest">Total Volume (ml)</span>
                    <div class="text-6xl font-black"><span id="totalVolDisplay">0</span> <small class="text-2xl text-emerald-300">ml</small></div>
                </div>
                <div class="bg-white/5 p-6 rounded-2xl border border-white/20">
                    <div class="text-yellow-400 text-base font-black mb-3 italic tracking-wide" id="rateHint">üëâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Product...</div>
                    <div class="flex items-center gap-4">
                        <input type="number" id="manualRate" placeholder="0.0" class="w-full bg-emerald-700 text-white text-4xl font-black p-4 rounded-2xl outline-none text-center placeholder-emerald-800">
                        <span class="text-2xl font-black">ml/hr</span>
                    </div>
                </div>
            </div>
            <button id="saveBtn" onclick="saveOrder()" class="w-full bg-emerald-500 hover:bg-emerald-400 p-8 rounded-3xl text-3xl font-black shadow-xl transition-all active:scale-95">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å</button>
        </section>
        <p class="text-center text-emerald-800 text-[10px] py-10 uppercase font-black tracking-[0.2em]">Srinagarind Hospital ‚Ä¢ Pharmacy Dept</p>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzaH4rJ663N7O0NrdqbAMiXqx9HYJAU-AsvXW5B6tB8_w8eZ06ui8GJDzo83e9scvPn/exec";

    const userMap = {
      'OP': '‡∏†‡∏ç.‡∏≠‡∏£‡∏õ‡∏†‡∏≤ ‡∏ä‡∏±‡∏¢‡πÄ‡∏•‡∏¥‡∏®‡∏ß‡∏≤‡∏ì‡∏¥‡∏ä', 'SK': '‡∏†‡∏ç.‡∏®‡∏¥‡∏£‡∏¥‡πÇ‡∏ä‡∏Ñ ‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏á‡∏®‡πå‡∏Å‡∏§‡∏ï', 'NC': '‡∏†‡∏ç.‡∏ì‡∏±‡∏ê‡∏ß‡∏£‡∏£‡∏ì ‡∏â‡πà‡∏≥‡∏°‡∏ì‡∏µ',
      'TT': '‡∏†‡∏ç.‡∏®‡∏¥‡∏£‡∏¥‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏≠‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏°‡∏Å‡∏°‡∏•', 'MP': '‡∏†‡∏ç.‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏§‡∏ó‡∏±‡∏¢ ‡∏û‡∏£‡∏´‡∏°‡∏´‡∏≤‡∏£‡∏≤‡∏ä', 'PC': '‡∏†‡∏ç.‡∏û‡∏¥‡∏ä‡∏ç‡∏≤‡∏ô‡∏¥‡∏• ‡∏ä‡∏≤‡∏ò‡∏£‡∏£‡∏°‡∏≤',
      'CK': '‡∏†‡∏ç.‡∏ä‡∏ô‡∏°‡πå‡∏ô‡∏¥‡∏†‡∏≤ ‡∏Å‡∏±‡∏ô‡∏´‡∏≤‡∏Å‡∏∏‡∏•', 'KM': '‡∏†‡∏ç.‡∏ò‡∏ì‡∏±‡∏ê‡∏†‡∏£‡∏ì‡πå ‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏Å‡∏¥‡∏à‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•', 'ST': '‡∏†‡∏ç.‡∏™‡∏∏‡∏ß‡∏¥‡∏°‡∏• ‡∏ò‡∏£‡∏£‡∏°‡∏Å‡∏∏‡∏•', 
      'LS': '‡∏†‡∏ç.‡∏•‡∏±‡∏Å‡∏©‡∏¥‡∏Å‡∏≤ ‡∏à‡∏¥‡∏ï‡∏£‡∏ä‡∏∑‡πà‡∏ô', 'SO': '‡∏†‡∏ç.‡∏≠‡∏¥‡∏™‡∏£‡∏≤ ‡πÇ‡∏™‡∏†‡∏±‡∏¢'
    };

    function handleLogin(e) {
      if (e) e.preventDefault();
      const u = document.getElementById('username').value.trim().toUpperCase();
      const p = document.getElementById('password').value.trim().toUpperCase();
      if (u === p && userMap[u]) {
        sessionStorage.setItem('tpnUser', userMap[u]);
        showMainApp();
      } else {
        alert('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™ ' + u + ' ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏∞');
      }
    }

    function showMainApp() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('displayUserName').textContent = sessionStorage.getItem('tpnUser');
      document.getElementById('orderDate').valueAsDate = new Date();
      calculateAll();
    }

    function logout() { sessionStorage.clear(); location.reload(); }

    function changeBag(val) {
      const display = document.getElementById('bagCountDisplay');
      const hiddenInput = document.getElementById('bagCount');
      let current = parseInt(hiddenInput.value);
      let newValue = current + val;
      if (newValue < 1) newValue = 1;
      hiddenInput.value = newValue;
      display.textContent = newValue;
    }

    const wards = ["2‡∏Ñ", "2‡∏á", "3‡∏Å", "3‡∏Ñ", "3‡∏á", "3‡∏â", "4‡∏Å", "4‡∏Ñ", "5‡∏Ç", "6‡∏Å", "6‡∏Ç", "AE1", "AE2", "AE3", "CCU", "CVT-ICU", "HOME PN", "IMC2‡∏á", "IMC3‡∏Ç", "IMC4‡∏Ç", "MICU 1", "MICU 2", "NICU", "PICU", "SCTU", "SICU 1", "SICU 2", "‡∏™‡∏ß.1/11", "‡∏™‡∏ß.1/9A"];
    function showWards() { document.getElementById('wardList').classList.remove('hidden'); renderWards(wards); }
    function renderWards(items) { document.getElementById('wardList').innerHTML = items.map(w => `<div class="p-4 hover:bg-emerald-50 cursor-pointer border-b font-black text-gray-700 text-center" onclick="selectWard('${w}')">${w}</div>`).join(''); }
    function filterWards() { const val = document.getElementById('wardInput').value.toLowerCase(); renderWards(wards.filter(w => w.toLowerCase().includes(val))); }
    function selectWard(w) { document.getElementById('wardInput').value = w; document.getElementById('wardList').classList.add('hidden'); }
    
    let currentVitType = '';
    function selectVitamin(type) {
      const vitVol = document.getElementById('vitVol');
      const vitalipid = document.getElementById('vitalipid');
      const vitHint = document.getElementById('vit-hint');
      currentVitType = type;
      document.getElementById('btn-cernevit').className = "flex-1 py-4 rounded-xl border-2 font-black text-xs uppercase bg-white text-gray-400";
      document.getElementById('btn-soluvit').className = "flex-1 py-4 rounded-xl border-2 font-black text-xs uppercase bg-white text-gray-400";
      if (type === 'cernevit') {
        document.getElementById('btn-cernevit').className = "flex-1 py-4 rounded-xl border-2 font-black text-xs uppercase bg-emerald-600 text-white shadow-md";
        vitVol.value = 5; vitHint.innerHTML = "‚ö†Ô∏è MAX CERNEVIT = 5 ML";
        vitalipid.value = 0; vitalipid.readOnly = true; vitalipid.classList.add('opacity-30', 'bg-gray-200');
      } else {
        document.getElementById('btn-soluvit').className = "flex-1 py-4 rounded-xl border-2 font-black text-xs uppercase bg-yellow-400 text-black shadow-md";
        vitVol.value = 10; vitHint.innerHTML = "‚ö†Ô∏è MAX SOLUVIT-N = 10 ML";
        vitalipid.value = 10; vitalipid.readOnly = false; vitalipid.classList.remove('opacity-30', 'bg-gray-200');
      }
      calculateAll();
    }

    function checkBcoLimit() {
      const bco = document.getElementById('bco');
      if (parseFloat(bco.value) > 2) bco.classList.add('text-red-700', 'bg-red-50');
      else bco.classList.remove('text-red-700', 'bg-red-50');
      calculateAll();
    }

    function updateProductDetails() {
      const s = document.getElementById('productSelect');
      const o = s.options[s.selectedIndex];
      document.getElementById('prodVol').textContent = o.getAttribute('data-vol') || 0;
      document.getElementById('prodKcal').textContent = o.getAttribute('data-kcal') || 0;
      calculateAll();
    }

    function calculateAll() {
      const v = (id) => parseFloat(document.getElementById(id).value) || 0;
      const prodVol = parseFloat(document.getElementById('prodVol').textContent) || 0;
      const vitVol = v('vitVol');
      const vitMaxMsg = document.getElementById('vit-max-msg');
      if ((currentVitType==='cernevit' && vitVol>5) || (currentVitType==='soluvit' && vitVol>10)) vitMaxMsg.classList.remove('invisible');
      else vitMaxMsg.classList.add('invisible');
      let otherTotal = 0;
      document.querySelectorAll('.other-vol').forEach(input => { otherTotal += parseFloat(input.value) || 0; });
      const grandTotal = prodVol + v('addamel') + vitVol + v('bco') + v('vitalipid') + otherTotal;
      document.getElementById('totalVolDisplay').textContent = grandTotal.toLocaleString();
      const rh = document.getElementById('rateHint');
      if (grandTotal > 0) { rh.textContent = `‚úÖ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${(grandTotal/24).toFixed(1)} ml/hr`; rh.style.color = "#bef264"; }
      else { rh.textContent = `üëâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Product...`; rh.style.color = "#facc15"; }
    }

    async function saveOrder() {
      const saveBtn = document.getElementById('saveBtn');
      const hn = document.getElementById('hn').value;
      const pName = document.getElementById('patientName').value;
      if (!hn || !pName) { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ HN ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏Ñ‡πà‡∏∞"); return; }
      
      const productSelect = document.getElementById('productSelect');
      if (productSelect.value === "") { alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏Ñ‡πà‡∏∞"); return; }

      const v = (id) => document.getElementById(id).value;
      const t = (id) => document.getElementById(id).textContent;
      
      // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      const formData = new URLSearchParams();
      formData.append("action", "saveOrder");
      formData.append("orderDate", v('orderDate'));
      formData.append("hn", hn);
      formData.append("patientName", pName);
      formData.append("ward", v('wardInput'));
      formData.append("route", document.querySelector('input[name="route"]:checked').value);
      formData.append("bw", v('bw'));
      formData.append("productName", productSelect.options[productSelect.selectedIndex].text);
      formData.append("productVol", t('prodVol'));
      formData.append("productKcal", t('prodKcal'));
      formData.append("quantity", v('bagCount'));
      formData.append("addamel", v('addamel'));
      formData.append("vitType", currentVitType);
      formData.append("vitVol", v('vitVol'));
      formData.append("bco", v('bco'));
      formData.append("vitalipid", v('vitalipid'));
      formData.append("other1Name", v('o1-name'));
      formData.append("other1Vol", v('o1-vol'));
      formData.append("other2Name", v('o2-name'));
      formData.append("other2Vol", v('o2-vol'));
      formData.append("other3Name", v('o3-name'));
      formData.append("other3Vol", v('o3-vol'));
      formData.append("other4Name", v('o4-name'));
      formData.append("other4Vol", v('o4-vol'));
      formData.append("totalVol", t('totalVolDisplay'));
      formData.append("rate", v('manualRate') || (parseFloat(t('totalVolDisplay').replace(/,/g,''))/24).toFixed(1));
      formData.append("recordedBy", sessionStorage.getItem('tpnUser'));

      saveBtn.disabled = true;
      saveBtn.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å...";

      try {
        await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors', // ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Apps Script
          body: formData
        });
        
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏â‡∏•‡∏≤‡∏Å
        const params = formData.toString();
        window.open(`label.html?${params}`, '_blank');
        
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞!");
        location.reload(); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà
      } catch (e) {
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
        saveBtn.disabled = false;
        saveBtn.innerHTML = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å";
      }
    }

    window.onload = () => { if (sessionStorage.getItem('tpnUser')) showMainApp(); };
  </script>
</body>
</html>
