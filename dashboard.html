<!doctype html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPN Dashboard | ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; }
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÅ‡∏ö‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Index */
    .gradient-header { background: linear-gradient(135deg, #065f46 0%, #10b981 100%); }
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .btn-action { 
      @apply flex-1 py-1.5 rounded-full text-[10px] font-black transition-all flex items-center justify-center gap-1 border-2 border-gray-100 bg-transparent text-gray-700; 
    }
    .btn-label:hover { @apply border-emerald-400 text-emerald-800; }
    .btn-off:hover { @apply border-red-400 text-red-800; }
  </style>
</head>
<body class="bg-gray-50 min-h-full">

  <header class="gradient-header text-white py-3 px-6 sticky top-0 z-50 shadow-lg">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-2xl">üìä</div>
        <div>
          <h1 class="text-lg font-bold uppercase tracking-tight text-white">TPN Order Dashboard</h1>
          <p class="text-emerald-50 text-[10px]">Srinagarind Hospital | KKU Pharmacy</p>
        </div>
      </div>
      <button onclick="window.location.href='index.html'" class="px-5 py-2 bg-white/10 hover:bg-white/20 rounded-full transition-all text-sm font-black border border-white/20 text-white">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 md:p-6 text-black">
    <div class="bg-white rounded-[2rem] shadow-sm p-6 mb-4 border border-gray-200">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-5 items-end font-black">
        <div class="flex flex-col">
          <span class="text-[11px] mb-1 uppercase tracking-wider text-emerald-800">üìÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
          <input type="date" id="startDate" class="px-4 py-2 rounded-2xl border-2 border-gray-100 focus:border-emerald-500 outline-none">
        </div>
        <div class="flex flex-col">
          <span class="text-[11px] mb-1 uppercase tracking-wider text-emerald-800">üìÖ ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
          <input type="date" id="endDate" class="px-4 py-2 rounded-2xl border-2 border-gray-100 focus:border-emerald-500 outline-none">
        </div>
        <div class="flex flex-col">
          <span class="text-[11px] mb-1 uppercase tracking-wider text-emerald-800">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ HN</span>
          <input type="text" id="filterHN" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏•‡∏Ç HN..." class="px-4 py-2 rounded-2xl border-2 border-gray-100 focus:border-emerald-500 outline-none" oninput="renderContent()">
        </div>
        <div class="flex items-center gap-3">
          <button onclick="loadData()" class="flex-1 px-4 py-2.5 bg-emerald-600 text-white rounded-full font-black text-xs shadow-md hover:bg-emerald-700 transition-all">üîÑ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <div class="text-right min-w-[50px]"><span id="caseCount" class="text-4xl font-black text-emerald-900 leading-none">0</span></div>
        </div>
      </div>
    </div>

    <div id="cardContainer" class="flex flex-col gap-3 animate-fade-in mb-8">
        </div>

    <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-200">
        <h3 class="font-black text-emerald-800 mb-4 flex items-center gap-2">üì¶ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏ö‡∏¥‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (‡∏ñ‡∏∏‡∏á)</h3>
        <div class="h-[300px]">
            <canvas id="inventoryChart"></canvas>
        </div>
    </div>

    <p class="text-center text-emerald-800 text-[10px] py-10 uppercase font-black tracking-[0.2em]">Srinagarind Hospital ‚Ä¢ Pharmacy Dept</p>
  </main>

  <script>
    let allOrders = [];
    let inventoryChart;

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;
        loadData();
    });

    function loadData() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        
        document.getElementById('cardContainer').innerHTML = `<div class="text-center py-10 font-black">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>`;
        
        google.script.run.withSuccessHandler(data => {
            allOrders = data;
            renderContent();
        }).getDashboardData(start, end);
    }

    function renderContent() {
        const container = document.getElementById('cardContainer');
        const fHN = document.getElementById('filterHN').value.toLowerCase();
        
        const filtered = allOrders.filter(o => (fHN ? o.hn?.toString().toLowerCase().includes(fHN) : true));
        
        document.getElementById('caseCount').innerText = filtered.length;
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
        const productStats = {};
        filtered.forEach(o => {
            const qty = parseFloat(o.quantity) || 0;
            productStats[o.productName] = (productStats[o.productName] || 0) + qty;
        });

        updateChart(productStats);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÅ‡∏ö‡∏ö Card ‡∏ï‡∏≤‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ç‡∏¥‡∏°‡∏ä‡∏≠‡∏ö
        if (filtered.length === 0) {
            container.innerHTML = `<div class="text-center py-10 bg-white rounded-3xl border-2 border-dashed border-gray-200 font-black">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`;
            return;
        }

        container.innerHTML = filtered.reverse().map(order => {
            const isC = order.route?.toLowerCase().includes('central');
            return `
            <div class="bg-white border-2 border-gray-200 rounded-[1.5rem] p-4 shadow-sm flex flex-col gap-4 hover:border-emerald-400 transition-all">
              <div class="flex items-center gap-5">
                <div class="flex flex-col items-center justify-center min-w-[85px] border-r-2 border-gray-100 pr-4">
                  <span class="text-3xl font-black text-black leading-none">${order.ward || '-'}</span>
                  <span class="${isC ? 'bg-red-600' : 'bg-emerald-600'} text-white text-[10px] px-3 py-1 rounded-full font-black mt-2 uppercase tracking-tight">${order.route || 'N/A'}</span>
                </div>
                <div class="flex-1 min-w-[180px]">
                  <h3 class="font-black text-xl text-black leading-tight">${order.patientName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</h3>
                  <p class="text-sm font-black text-black font-mono mt-1">HN: <span class="text-lg font-bold text-emerald-700">${order.hn}</span> | <span class="text-blue-700 bg-blue-50 px-2 rounded-lg">BW: ${order.bw} kg</span></p>
                </div>
                <div class="hidden md:flex gap-3 text-center min-w-[200px]">
                  <div class="flex-1 bg-gray-50 rounded-2xl p-2 border border-gray-200">
                    <span class="text-[9px] text-black block font-black uppercase mb-1">Total Vol</span>
                    <span class="text-lg font-black text-emerald-800">${order.totalVol || '0'}</span>
                  </div>
                </div>
              </div>
              <div class="flex gap-3 pt-3 border-t border-gray-100">
                <button onclick="window.open('label.html?row=${order.row_index}', '_blank')" class="btn-action btn-label">üè∑Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å</button>
                <button onclick="deleteOrder(${order.row_index})" class="btn-action btn-off">üóëÔ∏è OFF TPN</button>
              </div>
            </div>`;
        }).join('');
    }

    function updateChart(productData) {
        const ctx = document.getElementById('inventoryChart').getContext('2d');
        if (inventoryChart) inventoryChart.destroy();
        
        inventoryChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(productData),
                datasets: [{
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡∏∏‡∏á',
                    data: Object.values(productData),
                    backgroundColor: '#10b981', // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß Emerald
                    borderRadius: 12
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                  legend: { display: false }
                },
                scales: { 
                  y: { 
                    beginAtZero: true, 
                    ticks: { stepSize: 1, color: '#065f46', font: { weight: 'bold' } } 
                  },
                  x: {
                    ticks: { color: '#065f46', font: { weight: 'bold' } }
                  }
                }
            }
        });
    }

    async function deleteOrder(index) {
        if(!confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á Off TPN?")) return;
        alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà " + index + " (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ñ‡πà‡∏∞)");
    }
  </script>
</body>
</html>
