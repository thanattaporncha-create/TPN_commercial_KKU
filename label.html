<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>TPN Master Print | Srinagarind Hospital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; color: #000; line-height: 1.15; font-weight: 700; }
    
    @media print {
      @page { margin: 0; size: auto; }
      body { background: #fff; margin: 0; padding: 0; }
      .no-print { display: none !important; }
      .print-area:not(.active) { display: none !important; }
      .sticker { 
        box-shadow: none !important; 
        border: none !important; 
        margin: 3mm auto 0 auto !important; 
        page-break-after: always; 
        overflow: hidden; 
      }
    }

    [contenteditable="true"]:hover { background: #fff9c4; outline: 1px dashed #ccc; cursor: text; }

    /* ‡∏â‡∏•‡∏≤‡∏Å PN Big Label */
    .sticker-pn { 
      width: 9.1cm; 
      height: 12.9cm; 
      padding: 1.45cm 0.3cm 0.8cm 0.3cm; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Padding bottom ‡πÄ‡∏õ‡πá‡∏ô 0.8cm (‡∏¢‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô 5mm ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏°) */
      box-sizing: border-box; 
      background: white; 
      display: flex; 
      flex-direction: column;
      justify-content: flex-start;
    }

    /* ‡∏â‡∏•‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏∏‡∏á */
    .sticker-bag { 
      width: 3.75in; 
      height: 2.48in; 
      padding: 1.1cm 0.25in 0.1in 0.25in; 
      box-sizing: border-box; 
      background: white; 
    }

    .pn-table { width: 100%; font-size: 14.5px; border-collapse: collapse; border: 2px solid #000; margin-bottom: 2px; }
    .pn-table td { border: 1px solid #000; padding: 3px 6px; vertical-align: middle; } 
    .pn-table th { border: 2px solid #000; padding: 4px; font-size: 13.5px; font-weight: 800; background: #eee; }

    .header-info { font-size: 15.5px; font-weight: 800; border-bottom: 2.5px solid #000; margin-bottom: 4px; padding-bottom: 2px; }
    
    .footer-container { 
      display: flex; 
      justify-content: space-between; 
      align-items: flex-end; 
      width: 100%; 
      margin-top: auto; 
      border-top: 2px solid #000; 
      padding-top: 5px; 
      margin-bottom: 5px; /* ‡∏î‡∏±‡∏ô Footer ‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á Padding */
    }
    
    .rate-box { border: 2.5px solid #000; padding: 2px 8px; font-size: 16px; font-weight: 900; background: #fff; }
    .exp-text { font-size: 11px; text-align: right; font-weight: 800; line-height: 1.1; }
    .prep-text { font-size: 13px; font-weight: 800; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <div class="max-w-xl mx-auto py-8 px-4 no-print text-center">
    <h1 class="text-2xl font-black text-emerald-900 mb-6 uppercase tracking-tighter">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏â‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</h1>
    
    <div class="grid grid-cols-2 gap-4 mb-8">
      <div id="card-pn" onclick="selectSection('pn')" class="bg-white p-6 rounded-3xl border-4 border-emerald-100 cursor-pointer transition-all hover:scale-105 shadow-sm">
        <div class="text-3xl mb-2">üìÑ</div>
        <h3 class="font-black text-lg text-emerald-900">TPN COMMERCIAL</h3>
        <p class="text-xs text-gray-400 mt-1 uppercase font-bold">‡∏â‡∏•‡∏≤‡∏Å‡πÉ‡∏´‡∏ç‡πà / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
      </div>
      <div id="card-bag" onclick="selectSection('bag')" class="bg-white p-6 rounded-3xl border-4 border-emerald-100 cursor-pointer transition-all hover:scale-105 shadow-sm">
        <div class="text-3xl mb-2">üè∑Ô∏è</div>
        <h3 class="font-black text-lg text-emerald-900">‡∏â‡∏•‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏∏‡∏á</h3>
        <p class="text-xs text-gray-400 mt-1 uppercase font-bold">‡∏â‡∏•‡∏≤‡∏Å‡πÄ‡∏•‡πá‡∏Å / ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</p>
      </div>
    </div>

    <div id="action-btns" class="hidden">
      <button onclick="window.print()" class="bg-slate-900 text-white py-5 px-14 rounded-3xl font-black text-2xl shadow-xl hover:bg-black transition-all transform active:scale-95">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å</button>
    </div>
  </div>

  <div id="pn-area" class="print-area"></div>
  <div id="bag-area" class="print-area"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const data = Object.fromEntries(params.entries());
      if (data.hn) renderLabels(data);
    });

    function selectSection(type) {
      document.querySelectorAll('.print-area').forEach(el => el.classList.remove('active'));
      document.getElementById(`${type}-area`).classList.add('active');
      document.querySelectorAll('.bg-white').forEach(el => { el.style.borderColor = '#ecfdf5'; });
      document.getElementById(`card-${type}`).style.borderColor = '#10b981'; 
      document.getElementById('action-btns').classList.remove('hidden');
    }

    function formatThaiDate(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr);
      const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
      return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
    }

    function createRow(label, value) {
      const val = parseFloat(value);
      if (!value || isNaN(val) || val === 0) return '';
      let displayLabel = label;
      if (label.includes('soluvit')) displayLabel = '3. Soluvit-N';
      else if (label.includes('cernevit')) displayLabel = '3. Cernevit';
      else if (label.includes('bco')) displayLabel = '4. B-Complex';
      return `<tr><td>${displayLabel}</td><td class="text-right">${value}</td></tr>`;
    }

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ SMOF ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 1
    function splitProductName(name) {
      if (name.includes(' ml / ')) {
        const match = name.match(/(\d{1,3}(,\d{3})* ml \/ \d+ kcal)/);
        if (match) {
          const spec = match[0];
          const productName = name.replace(spec, '').trim();
          return `<span>${productName}</span><br><span style="font-size: 11px; font-weight: 500; opacity: 0.9;">${spec}</span>`;
        }
      }
      return `<span>${name}</span>`;
    }

    function renderLabels(o) {
      const expDate = new Date(o.orderDate);
      expDate.setDate(expDate.getDate() + 1);
      const routeDisplay = o.route.includes('Central') ? 'C-line' : 'P-line';

      const qty = parseInt(o.quantity) || 1;
      let pnHTML = '';
      for (let i = 1; i <= qty; i++) {
        pnHTML += `
          <div class="sticker sticker-pn">
            <div class="header-info flex justify-between" contenteditable="true">
              <span>HN: ${o.hn} - ${o.patientName}</span>
              <span>${i}/${qty}</span>
            </div>
            <div class="flex justify-between text-[14.5px] font-bold mb-1.5" contenteditable="true">
              <span>Ward: ${o.ward}</span>
              <span>Route: ${routeDisplay}</span>
            </div>
            <table class="pn-table">
              <thead>
                <tr><th style="text-align:left;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</th><th style="width:25%;">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£</th></tr>
              </thead>
              <tbody contenteditable="true">
                <tr><td>1. ${splitProductName(o.productName)}</td><td class="text-right">${o.productVol}</td></tr>
                ${createRow('2. Addamel-N', o.addamel)}
                ${createRow(o.vitType === 'soluvit' ? 'soluvit' : 'cernevit', o.vitVol)}
                ${createRow('bco', o.bco)}
                ${createRow('5. Vitalipid Adult', o.vitalipid)}
                ${createRow(`${o.other1Name}`, o.other1Vol)}
                ${createRow(`${o.other2Name}`, o.other2Vol)}
                ${createRow(`${o.other3Name}`, o.other3Vol)}
                ${createRow(`${o.other4Name}`, o.other4Vol)}
                <tr style="background:#eee; font-weight:800;">
                  <td class="text-right">Total Volume</td>
                  <td class="text-right">${o.totalVol}</td>
                </tr>
              </tbody>
            </table>
            <div class="footer-container" contenteditable="true">
              <div class="text-[14px] font-bold">
                <div class="text-xs text-gray-500 mb-1">Energy: ${o.productKcal} kcal</div>
                <div class="prep-text">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(o.orderDate)}</div>
              </div>
              <div class="text-right flex flex-col items-end">
                <div class="rate-box inline-block mb-1">Rate: ${o.rate} ml/hr</div>
                <div class="exp-text">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${formatThaiDate(expDate)} ‡πÄ‡∏ß‡∏•‡∏≤ 18:00 ‡∏ô.</div>
              </div>
            </div>
          </div>
        `;
      }
      document.getElementById('pn-area').innerHTML = pnHTML;

      document.getElementById('bag-area').innerHTML = `
        <div class="sticker sticker-bag flex flex-col items-center justify-center text-center" contenteditable="true">
          <div style="font-size: 52px; font-weight: 900; line-height: 1;">${o.ward}</div>
          <div style="border-top: 4px solid #000; border-bottom: 4px solid #000; width: 100%; padding: 8px 0; margin: 8px 0;">
            <span style="font-size: 26px; font-weight: 900; display: block; line-height: 1.1;">${o.patientName}</span>
          </div>
          <div style="font-size: 22px; font-weight: 800; margin-bottom: 4px;">HN: ${o.hn}</div>
          <div style="font-size: 16px; font-weight: 700;">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDate(o.orderDate)}</div>
          <div style="font-size: 15px; font-weight: 800; color: #000; margin-top: 6px;">(‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô 2-8¬∞ C)</div>
        </div>
      `;
    }
  </script>
</body>
</html>
