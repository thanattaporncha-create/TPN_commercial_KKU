<!doctype html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>TPN Master Print | Srinagarind Hospital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; color: #000; line-height: 1.1; font-weight: 700; }
    
    @media print {
      @page { margin: 0; size: auto; }
      body { background: #fff; margin: 0; padding: 0; }
      .no-print { display: none !important; }
      .print-area:not(.active) { display: none !important; }
      .sticker { 
        box-shadow: none !important; 
        border: none !important; 
        margin: 3mm auto 0 auto !important; 
        page-break-after: always;
        overflow: hidden;
      }
    }

    /* ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡πÑ‡∏ß‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */
    .sticker-pn { 
      width: 9.1cm; height: 12.9cm; padding: 1.45cm 0.3cm 0.5cm 0.3cm; 
      box-sizing: border-box; background: white; position: relative; display: flex; flex-direction: column;
    }

    .pn-table { width: 100%; border-collapse: collapse; border: 2px solid #000; table-layout: fixed; }
    .pn-table td { border: 1px solid #000; vertical-align: middle; word-wrap: break-word; }
    .pn-table th { border: 2px solid #000; padding: 4px; font-size: 14px; background: #eee; }

    /* ‡πÇ‡∏´‡∏°‡∏î 1: ‡∏™‡∏≤‡∏£‡∏ô‡πâ‡∏≠‡∏¢ (<= 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) - ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÉ‡∏´‡∏ç‡πà 7% */
    .large-mode .pn-table td { padding: 8px 6px; font-size: 18px; }
    .large-mode .header-info { font-size: 17px; }

    /* ‡πÇ‡∏´‡∏°‡∏î 2: ‡∏™‡∏≤‡∏£‡πÄ‡∏¢‡∏≠‡∏∞ (6-9 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) - ‡πÇ‡∏Ñ‡πâ‡∏î Perfect ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î */
    .compact-mode .pn-table td { padding: 3px 6px; font-size: 15.5px; }
    .compact-mode .header-info { font-size: 15.5px; }

    .header-info { border-bottom: 2.5px solid #000; margin-bottom: 4px; padding-bottom: 2px; }
    
    /* ‡∏•‡πá‡∏≠‡∏Ñ Footer ‡πÑ‡∏ß‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 1.05cm ‡πÄ‡∏™‡∏°‡∏≠ */
    .footer-container { 
      position: absolute; bottom: 1.05cm; left: 0.3cm; right: 0.3cm;
      border-top: 2px solid #000; padding-top: 6px; display: grid; grid-template-columns: 1fr 1fr;
    }
    
    .rate-box { border: 2.5px solid #000; padding: 2px 8px; font-size: 18px; font-weight: 900; background: #fff; }
    .exp-text { font-size: 11.5px; text-align: right; line-height: 1.2; margin-top: 2px; }
    .energy-text { font-size: 15px; }

    [contenteditable="true"]:hover { background: #fff9c4; outline: 1px dashed #ccc; cursor: text; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">

  <div class="max-w-xl mx-auto py-8 no-print text-center">
    <h1 class="text-2xl font-black text-emerald-900 mb-6 uppercase">üñ®Ô∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</h1>
    <div class="grid grid-cols-2 gap-4 mb-8">
      <div id="card-pn" onclick="selectSection('pn')" class="bg-white p-6 rounded-3xl border-4 border-emerald-100 cursor-pointer shadow-sm hover:scale-105 transition-transform">
        <div class="text-3xl mb-2">üìÑ</div>
        <h3 class="font-black text-lg text-emerald-900">TPN Label</h3>
        <p id="mode-hint" class="text-xs text-emerald-600 font-bold mt-1"></p>
      </div>
      <div id="card-bag" onclick="selectSection('bag')" class="bg-white p-6 rounded-3xl border-4 border-emerald-100 cursor-pointer shadow-sm hover:scale-105 transition-transform">
        <div class="text-3xl mb-2">üè∑Ô∏è</div>
        <h3 class="font-black text-lg text-emerald-900">‡∏â‡∏•‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏∏‡∏á</h3>
      </div>
    </div>
    <div id="action-btns" class="hidden">
      <button onclick="window.print()" class="bg-slate-900 text-white py-5 px-14 rounded-3xl font-black text-2xl shadow-xl active:scale-95">‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏â‡∏•‡∏≤‡∏Å</button>
    </div>
  </div>

  <div id="pn-area" class="print-area"></div>
  <div id="bag-area" class="print-area"></div>

  <script>
    let currentRowNum = 1;
    let activeRows = [];

    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const data = Object.fromEntries(params.entries());
      if (data.hn) renderLabels(data);
    });

    function selectSection(type) {
      document.querySelectorAll('.print-area').forEach(el => el.classList.remove('active'));
      document.getElementById(`${type}-area`).classList.add('active');
      document.querySelectorAll('.bg-white').forEach(el => el.style.borderColor = '#ecfdf5');
      document.getElementById(`card-${type}`).style.borderColor = '#10b981'; 
      document.getElementById('action-btns').classList.remove('hidden');
    }

    function formatThaiDate(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr);
      const months = ["‡∏°.‡∏Ñ.", "‡∏Å.‡∏û.", "‡∏°‡∏µ.‡∏Ñ.", "‡πÄ‡∏°.‡∏¢.", "‡∏û.‡∏Ñ.", "‡∏°‡∏¥.‡∏¢.", "‡∏Å.‡∏Ñ.", "‡∏™.‡∏Ñ.", "‡∏Å.‡∏¢.", "‡∏ï.‡∏Ñ.", "‡∏û.‡∏¢.", "‡∏ò.‡∏Ñ."];
      return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
    }

    function prepareRows(o) {
      const rows = [];
      const addRow = (label, val) => {
        if (val && parseFloat(val) > 0) rows.push({label, val});
      };
      
      // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ > 0
      addRow(o.productName, o.productVol);
      addRow('Addamel-N', o.addamel);
      addRow(o.vitType === 'soluvit' ? 'Soluvit-N' : '‚óÜ Cernevit ‚óÜ', o.vitVol);
      addRow('B-Complex', o.bco);
      addRow('Vitalipid-N Adult', o.vitalipid);
      addRow(o.other1Name, o.other1Vol);
      addRow(o.other2Name, o.other2Vol);
      addRow(o.other3Name, o.other3Vol);
      addRow(o.other4Name, o.other4Vol);
      
      return rows;
    }

    function renderLabels(o) {
      const expDate = new Date(o.orderDate);
      expDate.setDate(expDate.getDate() + 1);
      const rows = prepareRows(o);
      const rowCount = rows.length;
      
      // ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î
      const isLarge = rowCount <= 5;
      const modeClass = isLarge ? 'large-mode' : 'compact-mode';
      document.getElementById('mode-hint').innerText = isLarge ? '‚ú® Auto: Large Mode' : '‚ú® Auto: Compact Mode';

      const qty = parseInt(o.quantity) || 1;
      let pnHTML = '';

      for (let i = 1; i <= qty; i++) {
        let tableBody = '';
        rows.forEach((row, index) => {
          let labelText = row.label;
          if (index === 0) { // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô ProductName
            if (labelText.includes(' ml / ')) {
              const match = labelText.match(/(\d{1,3}(,\d{3})* ml \/ \d+ kcal)/);
              if (match) {
                const spec = match[0];
                const pName = labelText.replace(spec, '').trim();
                labelText = `<span>${pName}</span><br><span style="font-size: 0.8em; font-weight: 800;">${spec}</span>`;
              }
            }
          }
          tableBody += `<tr><td>${index + 1}. ${labelText}</td><td class="text-right">${row.val}</td></tr>`;
        });

        pnHTML += `
          <div class="sticker sticker-pn ${modeClass}">
            <div class="header-info flex justify-between" contenteditable="true">
              <span>HN: ${o.hn} - ${o.patientName}</span>
              <span>${i}/${qty}</span>
            </div>
            <div class="flex justify-between text-[14.5px] font-bold mb-1.5" contenteditable="true">
              <span>Ward: ${o.ward}</span>
              <span>Route: ${o.route.includes('Central') ? 'C-line' : 'P-line'}</span>
            </div>
            
            <table class="pn-table">
              <thead>
                <tr><th style="text-align:left;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</th><th style="width:30%;">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ï‡∏£ (ml)</th></tr>
              </thead>
              <tbody contenteditable="true">
                ${tableBody}
                <tr style="background:#eee; font-weight:800;">
                  <td class="text-right">Total Volume (ml)</td>
                  <td class="text-right">${o.totalVol}</td>
                </tr>
              </tbody>
            </table>

            <div class="footer-container" contenteditable="true">
              <div class="energy-text">Energy: ${o.productKcal} kcal</div>
              <div class="text-right flex flex-col items-end">
                <div class="rate-box mb-1">Rate: ${o.rate} ml/hr</div>
                <div class="exp-text">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${formatThaiDate(expDate)}<br>‡πÄ‡∏ß‡∏•‡∏≤ 18:00 ‡∏ô.</div>
              </div>
            </div>
          </div>
        `;
      }
      document.getElementById('pn-area').innerHTML = pnHTML;

      // ‡∏â‡∏•‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏∏‡∏á (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°)
      document.getElementById('bag-area').innerHTML = `
        <div class="sticker sticker-pn flex flex-col items-center justify-center text-center" style="width:3.75in; height:2.48in; padding:1.1cm 0.25in 0.1in 0.25in;" contenteditable="true">
          <div style="font-size: 52px; font-weight: 900; line-height: 1;">${o.ward}</div>
          <div style="border-top: 4px solid #000; border-bottom: 4px solid #000; width: 100%; padding: 8px 0; margin: 8px 0;">
            <span style="font-size: 26px; font-weight: 900; display: block; line-height: 1.1;">${o.patientName}</span>
          </div>
          <div style="font-size: 22px; font-weight: 800; margin-bottom: 4px;">HN: ${o.hn}</div>
          <div style="font-size: 16px; font-weight: 700;">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${formatThaiDate(o.orderDate)}</div>
          <div style="font-size: 15px; font-weight: 800; color: #000; margin-top: 6px;">(‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô 2-8¬∞ C)</div>
        </div>
      `;
    }
  </script>
</body>
</html>
